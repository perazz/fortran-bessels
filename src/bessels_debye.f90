!  ************************************************************************************************************
!
!                                    ____  ________________ ________   _____
!                                   / __ )/ ____/ ___/ ___// ____/ /  / ___/
!                                  / __  / __/  \__ \\__ \/ __/ / /   \__ \
!                                 / /_/ / /___ ___/ /__/ / /___/ /______/ /
!                                /_____/_____//____/____/_____/_____/____/
!
!                                       Debye asymptotic expansions
!
!  MIT License
!
!  Copyright (c) 2022 Federico Perini
!  Copyright (c) 2021-2022 Michael Helton, Oscar Smith, and the Bessels.jl contributors
!
!  This file contains the debye asymptotic asymptotic expansions for large orders.
!  These routines can be used to calculate `besselj`, `bessely`, `besselk`, `besseli` and the Hankel
!  functions. These are uniform expansions for `besselk` and `besseli` for large orders.
!  The forms used for `besselj` and `bessely` as well as the Hankel functions follow the notation by
!  Matviyenko [1] but also see similar forms provided by NIST 10.19. All of these routines use a core
!  routine for calculating the U-polynomials (NIST 10.41.E9) where the coefficients are dependent on each
!  function. The forms for the modified Bessel functions `besselk` and `besseli` follow NIST 10.41 [3].
!  [1] Matviyenko, Gregory. "On the evaluation of Bessel functions." Appl Comp Harm An 1.1 (1993): 116-135.
!  [2] http://dlmf.nist.gov/10.41.E9
!  [3] https://dlmf.nist.gov/10.41
!
!  ************************************************************************************************************
module bessels_debye
    use bessels_constants
    implicit none
    private

    ! Large order expansion for J_{nu}(x) and Y_{nu}(x) and v > x
    public :: besseljy_debye
    public :: besseljy_large_argument
    public :: hankel_debye

    interface Uk_poly20
        module procedure Uk_poly20
        module procedure Uk_poly20_split
    end interface Uk_poly20
    interface Uk_poly10
        module procedure Uk_poly10
        module procedure Uk_poly10_split
    end interface Uk_poly10
    interface Uk_poly5
        module procedure Uk_poly5
        module procedure Uk_poly5_split
    end interface Uk_poly5

    contains


    ! Large order expansion for Hankel functions and x > v
    ! Debye's asymptotic expansion for large order valid when v < x.
    ! Return the Hankel function H(nu, x) = J(nu, x) + Y(nu, x)*im
    elemental complex(BK) function hankel_debye(nu, x)
        real(BK), intent(in) :: nu, x

        real(BK) :: vmx,vs,sqvs,n,p,p2,ab(2),Uk_Yn
        complex(BK) :: coef_Yn
        intrinsic :: sqrt


        vmx  = abs((nu + x) * (x - nu))
        vs   = sqrt(vmx)
        sqvs = ONE/sqrt(vs)

        n    = vs - nu*acos(nu/x) - PIO4

        coef_Yn = SQ2OPI * exp(n*IM) * sqvs

        p    = nu/vs
        p2   = nu**2/vmx

        ab    = Uk_poly_Hankel(p, nu, -p2, x) ! why p*im ?
        Uk_Yn = IM*ab(2)

        hankel_debye = coef_Yn * Uk_Yn

    end function hankel_debye

    ! Debye's asymptotic expansion for large order valid when v-> Â° and x < v.
    ! Returns both besselj and bessely
    elemental subroutine besseljy_debye(v, x, besselj,bessely)
       real(BK), intent(in) :: v,x
       real(BK), intent(out) :: besselj,bessely

       real(BK) :: vmx,vs,sqvs,coef_Jn,coef_Yn,expn,p,p2,Uk_Jn,Uk_Yn,n
       intrinsic :: sqrt,log

       ! x<v so these are all real numbers
       vmx  = (v + x) * (v - x)
       vs   = sqrt(vmx)
       sqvs = ONE/sqrt(vs)

       n  = muladd(v, -log(x / (v + vs)), -vs)

       expn = exp(n)

       coef_Jn = SQ1O2PI * sqvs * expn
       coef_Yn = -SQ2OPI * sqvs / expn

       p   = v / vs
       p2  = v**2 / vmx

       call Uk_poly_Jn(p,v,p2, x, Uk_Jn, Uk_Yn)

       besselj = coef_Jn * Uk_Jn
       bessely = coef_Yn * Uk_Yn

    end subroutine besseljy_debye

    ! Debye large order expansion coefficients
    ! Implementation for arbitrary precision
    pure subroutine Uk_poly_Jn(p, v, p2, x, a,b)
        real(BK), intent(in) :: p,v,p2,x
        real(BK), intent(out) :: a,b

        real(BK) :: Poly(22)

        select case (BK)
           case (real32)
                call Uk_poly5(p, v, p2, a, b)
           case (real64)
                if (v > 5.0_BK + 1.00033_BK*x + 11.26_BK*cbrt(x)) then
                    call Uk_poly10(p, v, p2, a, b)
                else
                    call Uk_poly20(p, v, p2, a, b)
                endif
           case default
                call Uk_poly_Jn_generic(p2,Poly)
                call split_evalpoly(-p/v, Poly, a, b)
        end select

    end subroutine Uk_poly_Jn

    ! performs a second order horner scheme for polynomial evaluation
    ! computes the even and odd coefficients of the polynomial independently within a loop to reduce latency
    ! splits the polynomial to compute both 1 + ax + bx^2 + cx^3 and 1 - ax + bx^2 - cx^3 ....
    pure subroutine split_evalpoly(x,P,a,b)
        real(BK), intent(in) :: x,P(:)
        real(BK), intent(out) :: a,b

        real(BK) :: xx,out,out2
        integer :: N,i

        ! polynomial P must have an even number of terms
        N  = size(P)
        xx = x*x

        out  = P(N)
        out2 = P(N-1)

        do i=N-2,2,-2
            out  = muladd(xx, out, P(i))
            out2 = muladd(xx, out2, P(i-1))
        end do
        if (mod(N,2)==0) then
            out = out*x
            a = out2-out
        else
            out  = muladd(xx, out, P(1))
            out2 = out2*x
            a    = out-out2
        endif
        b = out2+out
    end subroutine split_evalpoly

    ! ***
    ! 5-th degree - polynomials
    ! ***
    pure subroutine Uk_poly5(p2,poly5)
        real(BK), intent(in) :: p2
        real(BK), intent(out) :: poly5(6)

        real(BK):: u(5)

        u(5) = evalpoly(6,p2,[0.22710800170898438_BK, -7.368794359479632_BK, 42.53499874538846_BK, -91.81824154324002_BK, 84.63621767460073_BK, -28.212072558200244_BK])
        u(4) = evalpoly(5,p2,[0.112152099609375_BK, -2.3640869140625_BK, 8.78912353515625_BK, -11.207002616222994_BK, 4.669584423426247_BK])
        u(3) = evalpoly(4,p2,[0.0732421875_BK, -0.8912109375_BK, 1.8464626736111112_BK, -1.0258125964506173_BK])
        u(2) = evalpoly(3,p2,[0.0703125_BK, -0.4010416666666667_BK, 0.3342013888888889_BK])
        u(1) = evalpoly(2,p2,[0.125_BK, -0.20833333333333334_BK])

        poly5 = [ONE, u]

    end subroutine Uk_poly5

    elemental subroutine Uk_poly5_split(p, v, p2, a,b)
        real(BK), intent(in) :: p,v,p2
        real(BK), intent(out) :: a,b
        real(BK) :: poly(6)
        call Uk_poly5(p2,poly)
        call split_evalpoly(-p/v, poly, a,b)
    end subroutine Uk_poly5_split

    ! ***
    ! 10-th degree - polynomials
    ! ***
    pure subroutine Uk_poly10(p2,poly10)
        real(BK), intent(in) :: p2
        real(BK), intent(out) :: poly10(11)

        real(BK) :: u(10)

        u(10) = evalpoly(11,p2, [110.01714026924674_BK, -13886.08975371704_BK, 308186.40461266245_BK, -2.7856181280864547e6_BK, 1.3288767166421818e7_BK, -3.7567176660763346e7_BK, 6.634451227472903e7_BK, -7.410514821153265e7_BK, 5.095260249266464e7_BK, -1.9706819118432228e7_BK, 3.284469853072038e6_BK])
        u(9 ) = evalpoly(10,p2, [24.380529699556064_BK, -2499.8304818112097_BK, 45218.76898136273_BK, -331645.17248456355_BK, 1.2683652733216248e6_BK, -2.8135632265865337e6_BK, 3.763271297656404e6_BK, -2.998015918538107e6_BK, 1.3117636146629772e6_BK, -242919.18790055133_BK])
        u(8 ) = evalpoly( 9,p2, [6.074042001273483_BK, -493.91530477308805_BK, 7109.514302489364_BK, -41192.65496889755_BK, 122200.46498301747_BK, -203400.17728041555_BK, 192547.00123253153_BK, -96980.59838863752_BK, 20204.29133096615_BK])
        u(7 ) = evalpoly( 8,p2, [1.7277275025844574_BK, -108.09091978839466_BK, 1200.9029132163525_BK, -5305.646978613403_BK, 11655.393336864534_BK, -13586.550006434136_BK, 8061.722181737309_BK, -1919.457662318407_BK])
        u(6 ) = evalpoly( 7,p2, [0.5725014209747314_BK, -26.491430486951554_BK, 218.1905117442116_BK, -699.5796273761325_BK, 1059.9904525279999_BK, -765.2524681411817_BK, 212.57013003921713_BK])
        u(5 ) = evalpoly( 6,p2, [0.22710800170898438_BK, -7.368794359479632_BK, 42.53499874538846_BK, -91.81824154324002_BK, 84.63621767460073_BK, -28.212072558200244_BK])
        u(4 ) = evalpoly( 5,p2, [0.112152099609375_BK, -2.3640869140625_BK, 8.78912353515625_BK, -11.207002616222994_BK, 4.669584423426247_BK])
        u(3 ) = evalpoly( 4,p2, [0.0732421875_BK, -0.8912109375_BK, 1.8464626736111112_BK, -1.0258125964506173_BK])
        u(2 ) = evalpoly( 3,p2, [0.0703125_BK, -0.4010416666666667_BK, 0.3342013888888889_BK])
        u(1 ) = evalpoly( 2,p2, [0.125_BK, -0.20833333333333334_BK])

        poly10 = [ONE, u]

    end subroutine Uk_poly10




    elemental subroutine Uk_poly10_split(p, v, p2, a,b)
        real(BK), intent(in) :: p,v,p2
        real(BK), intent(out) :: a,b
        real(BK) :: poly(11)
        call Uk_poly10(p2,poly)
        call split_evalpoly(-p/v, poly, a,b)
    end subroutine Uk_poly10_split

    ! ***
    ! 20-th degree - polynomials
    ! ***
    pure subroutine Uk_poly20(p2,poly20)
        real(BK), intent(in) :: p2
        real(BK), intent(out) :: poly20(0:20)

        real(BK) :: u(20)

        u(20) = evalpoly(21,p2, [3.646840080706556e10_BK, -1.818726203851104e13_BK, 1.5613123930484672e15_BK, -5.48403360388329e16_BK, 1.0461721131134344e18_BK, -1.2483700995047234e19_BK, 1.0126774169536592e20_BK, -5.8917941350694964e20_BK, 2.548961114664972e21_BK, -8.405915817108351e21_BK, 2.1487414815055883e22_BK, -4.302534303482379e22_BK, 6.783661642951883e22_BK, -8.423222750084323e22_BK, 8.19433100543513e22_BK, -6.173206302884415e22_BK, 3.528435843903409e22_BK, -1.4787743528433614e22_BK, 4.285296082829494e21_BK, -7.671943936729004e20_BK, 6.393286613940837e19_BK])
        u(19) = evalpoly(20,p2, [3.8362551802304335e9_BK, -1.7277040123529995e12_BK, 1.3412416915180639e14_BK, -4.2619355104268985e15_BK, 7.351663610930971e16_BK, -7.921651119323832e17_BK, 5.789887667664653e18_BK, -3.025566598990372e19_BK, 1.1707490535797259e20_BK, -3.434621399768417e20_BK, 7.756704953461136e20_BK, -1.360203777284994e21_BK, 1.8571089321463453e21_BK, -1.9677247077053125e21_BK, 1.6016898573693598e21_BK, -9.824438427689858e20_BK, 4.392792200888712e20_BK, -1.351217503435996e20_BK, 2.5563802960529236e19_BK, -2.242438856186775e18_BK])
        u(18) = evalpoly(19,p2, [4.259392165047669e8_BK, -1.722832387173505e11_BK, 1.2030115826419191e13_BK, -3.4396530474307594e14_BK, 5.335106978708839e15_BK, -5.1605093193485224e16_BK, 3.37667624979061e17_BK, -1.5736434765189599e18_BK, 5.402894876715982e18_BK, -1.3970803516443374e19_BK, 2.757282981650519e19_BK, -4.178861444656839e19_BK, 4.859942729324836e19_BK, -4.301555703831444e19_BK, 2.846521225167657e19_BK, -1.3639420410571592e19_BK, 4.47020096401231e18_BK, -8.966114215270463e17_BK, 8.30195760673191e16_BK])
        u(17) = evalpoly(18,p2, [5.0069589531988926e7_BK, -1.8078220384658062e10_BK, 1.128709145410874e12_BK, -2.886383763141476e13_BK, 4.0004445704303625e14_BK, -3.4503855118462725e15_BK, 2.0064271476309532e16_BK, -8.270945651585064e16_BK, 2.4960365126160426e17_BK, -5.62631788074636e17_BK, 9.575335098169139e17_BK, -1.2336116931960694e18_BK, 1.1961991142756308e18_BK, -8.592577980317548e17_BK, 4.4347954614171904e17_BK, -1.5552983504313904e17_BK, 3.3192764720355224e16_BK, -3.254192619642669e15_BK])
        u(16) = evalpoly(17,p2, [6.252951493434797e6_BK, -2.0016469281917763e9_BK, 1.1099740513917902e11_BK, -2.5215584749128545e12_BK, 3.100743647289646e13_BK, -2.3665253045164925e14_BK, 1.2126758042503475e15_BK, -4.3793258383640155e15_BK, 1.1486706978449752e16_BK, -2.2268225133911144e16_BK, 3.213827526858624e16_BK, -3.4447226006485144e16_BK, 2.705471130619708e16_BK, -1.5129826322457682e16_BK, 5.705782159023671e15_BK, -1.3010127235496995e15_BK, 1.3552215870309369e14_BK])
        u(15) = evalpoly(16,p2, [832859.3040162893_BK, -2.3455796352225152e8_BK, 1.1465754899448236e10_BK, -2.2961937296824646e11_BK, 2.4850009280340854e12_BK, -1.663482472489248e13_BK, 7.437312290867914e13_BK, -2.3260483118893994e14_BK, 5.230548825784446e14_BK, -8.57461032982895e14_BK, 1.0269551960827625e15_BK, -8.894969398810265e14_BK, 5.4273966498765975e14_BK, -2.213496387025252e14_BK, 5.417751075510605e13_BK, -6.019723417234006e12_BK])
        u(14) = evalpoly(15,p2, [118838.42625678326_BK, -2.9188388122220814e7_BK, 1.2470092935127103e9_BK, -2.1822927757529224e10_BK, 2.0591450323241e11_BK, -1.1965528801961816e12_BK, 4.612725780849132e12_BK, -1.2320491305598287e13_BK, 2.334836404458184e13_BK, -3.166708858478516e13_BK, 3.056512551993532e13_BK, -2.0516899410934438e13_BK, 9.109341185239898e12_BK, -2.406297900028504e12_BK, 2.86464035717679e11_BK])
        u(13) = evalpoly(14,p2, [18257.755474293175_BK, -3.8718334425726123e6_BK, 1.43157876718889e8_BK, -2.167164983223795e9_BK, 1.763473060683497e10_BK, -8.786707217802327e10_BK, 2.879006499061506e11_BK, -6.453648692453765e11_BK, 1.0081581068653821e12_BK, -1.0983751560812233e12_BK, 8.192186695485773e11_BK, -3.990961752244665e11_BK, 1.144982377320258e11_BK, -1.4679261247695616e10_BK])
        u(12) = evalpoly(13,p2, [3038.090510922384_BK, -549842.3275722887_BK, 1.7395107553978164e7_BK, -2.2510566188941526e8_BK, 1.5592798648792574e9_BK, -6.563293792619285e9_BK, 1.79542137311556e10_BK, -3.3026599749800724e10_BK, 4.1280185579753975e10_BK, -3.4632043388158775e10_BK, 1.8688207509295826e10_BK, -5.866481492051847e9_BK, 8.147890961183121e8_BK])
        u(11) = evalpoly(12,p2, [551.3358961220206_BK, -84005.4336030241_BK, 2.2437681779224495e6_BK, -2.4474062725738727e7_BK, 1.420629077975331e8_BK, -4.9588978427503026e8_BK, 1.1068428168230145e9_BK, -1.6210805521083372e9_BK, 1.5535968995705802e9_BK, -9.394623596815784e8_BK, 3.2557307418576574e8_BK, -4.932925366450996e7_BK])
        u(10) = evalpoly(11,p2, [110.01714026924674_BK, -13886.08975371704_BK, 308186.40461266245_BK, -2.7856181280864547e6_BK, 1.3288767166421818e7_BK, -3.7567176660763346e7_BK, 6.634451227472903e7_BK, -7.410514821153265e7_BK, 5.095260249266464e7_BK, -1.9706819118432228e7_BK, 3.284469853072038e6_BK])
        u(9 ) = evalpoly(10,p2, [24.380529699556064_BK, -2499.8304818112097_BK, 45218.76898136273_BK, -331645.17248456355_BK, 1.2683652733216248e6_BK, -2.8135632265865337e6_BK, 3.763271297656404e6_BK, -2.998015918538107e6_BK, 1.3117636146629772e6_BK, -242919.18790055133_BK])
        u(8 ) = evalpoly( 9,p2, [6.074042001273483_BK, -493.91530477308805_BK, 7109.514302489364_BK, -41192.65496889755_BK, 122200.46498301747_BK, -203400.17728041555_BK, 192547.00123253153_BK, -96980.59838863752_BK, 20204.29133096615_BK])
        u(7 ) = evalpoly( 8,p2, [1.7277275025844574_BK, -108.09091978839466_BK, 1200.9029132163525_BK, -5305.646978613403_BK, 11655.393336864534_BK, -13586.550006434136_BK, 8061.722181737309_BK, -1919.457662318407_BK])
        u(6 ) = evalpoly( 7,p2, [0.5725014209747314_BK, -26.491430486951554_BK, 218.1905117442116_BK, -699.5796273761325_BK, 1059.9904525279999_BK, -765.2524681411817_BK, 212.57013003921713_BK])
        u(5 ) = evalpoly( 6,p2, [0.22710800170898438_BK, -7.368794359479632_BK, 42.53499874538846_BK, -91.81824154324002_BK, 84.63621767460073_BK, -28.212072558200244_BK])
        u(4 ) = evalpoly( 5,p2, [0.112152099609375_BK, -2.3640869140625_BK, 8.78912353515625_BK, -11.207002616222994_BK, 4.669584423426247_BK])
        u(3 ) = evalpoly( 4,p2, [0.0732421875_BK, -0.8912109375_BK, 1.8464626736111112_BK, -1.0258125964506173_BK])
        u(2 ) = evalpoly( 3,p2, [0.0703125_BK, -0.4010416666666667_BK, 0.3342013888888889_BK])
        u(1 ) = evalpoly( 2,p2, [0.125_BK, -0.20833333333333334_BK])

        poly20 = [ONE, u]

    end subroutine Uk_poly20

    elemental subroutine Uk_poly20_split(p, v, p2, a,b)
        real(BK), intent(in) :: p,v,p2
        real(BK), intent(out) :: a,b
        real(BK) :: poly(21)
        call Uk_poly20(p2,poly)
        call split_evalpoly(-p/v, poly, a,b)
    end subroutine Uk_poly20_split

    ! Debye large order expansion coefficients
    ! Implementation for arbitrary precision
    pure function Uk_poly_Hankel(p, v, p2, x) result(ab)
        real(BK), intent(in) :: p,v,p2,x

        real(BK) :: Poly(22),ab(2)

        select case (BK)
           case (real32)
                call Uk_poly5(p, v, p2, ab(1), ab(2))
           case (real64)
                if (v < 5.0_BK + 0.998_BK*x + 10.541_BK*cbrt(-x)) then
                    call Uk_poly10(p, v, p2, ab(1), ab(2))
                else
                    call Uk_poly20(p, v, p2, ab(1), ab(2))
                endif
           case default
                call Uk_poly_Jn_generic(p2,Poly)
                call split_evalpoly(-p/v, Poly, ab(1), ab(2))
        end select

    end function Uk_poly_Hankel



    pure subroutine Uk_poly_Jn_generic(p2,u)
        real(BK), intent(in) :: p2
        real(BK), intent(out) :: u(0:21)

        u(21) = evalpoly(22,p2,[1990919576929585163761247434580873723897677550573731281207275390625.0_BK,-1094071724893410272201314846735800345180930752601602224440504638671875.0_BK,103359845691236916270005420886293061281368263471845448279855946394531250.0_BK,-3993558675585831919973605001813276532326292885934464373884268722794718750.0_BK,83832389176247515253189196480455786065824463879054932596114704927571390625.0_BK,-1101977288759423115916484463959767795703317649005495798822550381533967842875.0_BK,9865413224996821913093061266347613112205666995211786544733850490740903131000.0_BK,-63509799534443193918054738326913581450607131662586232327271654588312820660616.0_BK,305080179205137176095342856930260393560550505786421683990077008259370104309410.0_BK,-1122099959965657526344757894103766710826629020929459670948834078441128579791750.0_BK,3217185258543282976637373169047731813093578126603884759856059695249999306047500.0_BK,-7276835259402589085458442196686990645669654847254510877738804991391058411412500.0_BK,13076651508858985557227319801010895818335803028865299751194038965212274849406250.0_BK,-18719023753854332443081892087572754119280558462994056787647908433841920235468750.0_BK,21307327225910629020600045595173860611314592374884901403059587980149276271875000.0_BK,-19156728115567236234371593788102013666866274144599851347429312225076676478125000.0_BK,13430107219321888006291381503763318985372222835071804983658005207838642173828125.0_BK,-7186150593017474773099947110903785965879266917528290917207712073663895771484375.0_BK,2834031566467842832851805860262261718160136985649155528263587796394390332031250.0_BK,-776308737033643856044315139790308583914612827783322139063211433790569824218750.0_BK,131897976398031751060811874321878385924211075364673046295410087596954345703125.0_BK,-10468093364923154846096180501736379835254847251164527483762705364837646484375.0_BK]) / 5456052820246562178600318839637653652351064473600000000.0_BK
        u(20) = evalpoly(21,p2,[24030618487110150352755402740028995969072485932314476318359375.0_BK,-11984379509393886990049682627416290126645799829432886859195312500.0_BK,1028816773596376675865176501621547688509187479681533744365175781250.0_BK,-36136687211104276266628386141898079997731413843884113675698994212500.0_BK,689368394712060288513879526213143279387995331221181709158682715671875.0_BK,-8226054591925395046897310265711439061232478740113589342810359827971600.0_BK,66729727980314206345594148553023187689855688854650386958448499394886808.0_BK,-388235990422199036481157075090292917209702371811112714609151030385239376.0_BK,1679621555358289731717827244171539003686077073065087747585589973854567950.0_BK,-5539024239213671573375139503069183935283937579486175606155069574939719000.0_BK,14158993985687610069291256086138044030538819617545349322200892501730615500.0_BK,-28351273454978996507857547213496220444080209057761228571819950144231575000.0_BK,44700502703654649774362294361156754154712937287563245669685024068473468750.0_BK,-55504285315413734114196925709059066734450069228526494661323483726671250000.0_BK,53996017865021964397812742861916826936440170527545458081631955240159375000.0_BK,-40677946447845849750014263157052100427921007881029648608310681741346250000.0_BK,23250401373415767366970579801426233116241475047289980901600427561701171875.0_BK,-9744288621182737996606001891415854305391392962559389056448157541132812500.0_BK,2823768330714179467082676027577350697536971031741905897356560592675781250.0_BK,-505537818270094147077012813306995849751437826286925078626556809570312500.0_BK,42128151522507845589751067775582987479286485523910423218879734130859375.0_BK]) / 658943577324464031231922565173629668158341120000000.0_BK
        u(19) = evalpoly(20,p2,[3761719809509744584195141470215239968860161850335693359375.0_BK,-1694136104847790923543013061207680485991618397125797873046875.0_BK,131518243789528012257323287684549590712219590887856743595703125.0_BK,-4179129511260217209133623104486559148268490002722848244991240625.0_BK,72088266652871136165181276891337618088740053757385007292240377500.0_BK,-776773977214820033621339638022401758862209813648991378355261599500.0_BK,5677394779818071523358076045292335690018332546439714641415150037636.0_BK,-29667822591847140970922062603154078948366431649274897672067206014580.0_BK,114800233558787974267088388638654159779991991716667850063043161177890.0_BK,-336788945225975997668966486515468748933754942064781256509404101275850.0_BK,760599837839891632010677514872412397427959022966733699428711208643750.0_BK,-1333776105497652608917805362422659621440699261908512326717363285968750.0_BK,1821026790520428617034899967974569000414933301802005578083458082187500.0_BK,-1929493390007550512825649545883182667978851358936168551128507440937500.0_BK,1570570304135828069768211937927131121377451398878663909061910457812500.0_BK,-963355744456233323886326422779275308259891167457840027230510476562500.0_BK,430744376085805585076333464506126217301082462279781595185335615234375.0_BK,-132496442776420617057548516091451843431549350710841121872822607421875.0_BK,25067118709566753991500713640672585065184296412786618544560205078125.0_BK,-2198870062242697718552694179006367110981078632700580574084228515625.0_BK]) / 980570799589976236952265721984567958568960000000.0_BK
        u(18) = evalpoly(19,p2,[17402648254366970318896442155853313710334325579833984375.0_BK,-7038996381042630440706320955207218277836259136214144531250.0_BK,491515845627995608630308828025937223574193727753376100859375.0_BK,-14053430579296992819276840860026711644143962037898462198750000.0_BK,217977088167107844476671248240850549184342689357081793983627500.0_BK,-2108435312318793739666233505677933977608124223061200130648299000.0_BK,13796125542556918366536045481173150324297945459901440053845493532.0_BK,-64294535084989436534160300189785402934009324116808204634140090960.0_BK,220746706223415685134843293656748091845034254294736425040548604450.0_BK,-570806748959722117700578156666367879819767325936645047354739587500.0_BK,1126546324172034608288726239622146620694308510621969350884171781250.0_BK,-1707362295067866555400074337741150183369276187369879432556935250000.0_BK,1985632470023144029098600377248581775333320983961309350778555937500.0_BK,-1757491631661175749558620292180560395062012011157079033996696875000.0_BK,1163006497421870129179321717633624986894646606476886508372367187500.0_BK,-557267390747417776045984733477369082240579802825315540376718750000.0_BK,182639522233726398821209338567430722027981720466294556325849609375.0_BK,-36632957438678377189819992330283878474735514770655121685644531250.0_BK,3391940503581331221279628919470729488401436552838437193115234375.0_BK]) / 40857116649582343206344405082690331607040000000.0_BK
        u(17) = evalpoly(18,p2,[86098445290621992919710288959076381992996044921875.0_BK,-31086866964344776434901340294726759585844523939453125.0_BK,1940900724642360326780559417863159500982538936987375000.0_BK,-49633551391469586967911551642521760042791355027620125000.0_BK,687906693873155071735691272079937403263685738018470814500.0_BK,-5933198793919698447982330692598158428032189878414161012124.0_BK,34502031994800767344892422746634773296018107824906632419848.0_BK,-142225164683992765990030747899409462088308925365682017857240.0_BK,429212352515026773475471295511415883382060846328770993005250.0_BK,-967487903877461958325237917115228310512630590714451916640750.0_BK,1646551275524985252738847924398650627672209050734790851265000.0_BK,-2121288587929318041669932345514745412624685501425210767875000.0_BK,2056954829464921151146089484749565775448230537475447606562500.0_BK,-1477558757838664620053280135342775196503230238657956773437500.0_BK,762596613990574496129519527341431797422236075424587596875000.0_BK,-267445311988545069854943494211913506927580321987738265625000.0_BK,57077468859498937494621367436714109067308943816271513671875.0_BK,-5595830280343033087707977199677853830128327825124658203125.0_BK]) / 1719575616564913434610454759372488704000000.0_BK
        u(16) = evalpoly(17,p2,[23579874823845695868333654121829112397998046875.0_BK,-7548208883093506123919073318645848440986281250000.0_BK,418571121445853600940987397062487467273966779625000.0_BK,-9508794888602532435079114127493385198079570710470000.0_BK,116929016866180520574682795493722856433879981336112500.0_BK,-892416493340003758691506680694321990355675722520838096.0_BK,4572999438129700505777642155788222350797540050279284760.0_BK,-16514434054042671665093745143345645271999901089177788400.0_BK,43316362356947864694367448897560019067412728259897505250.0_BK,-83973458255376217113431722753277764119484494850353270000.0_BK,121193409013842312774251134029225218007034205572281375000.0_BK,-129900460304939941764670297010274798325693206430601250000.0_BK,102023293586271009821923530738271106285703628596295312500.0_BK,-57054562339825052419659481088225652020508564894843750000.0_BK,21516499723877657209702638528530839860502345904015625000.0_BK,-4906117886528008036369575428500807148681084440781250000.0_BK,511053946513334170455164107135500744654279629248046875.0_BK]) / 3770999159133582093443979735465984000000.0_BK
        u(15) = evalpoly(16,p2,[8178936810213560828419581728001773291015625.0_BK,-2303431987527333128955769182299845911305390625.0_BK,112597271053778779753048514469995937998172890625.0_BK,-2254933495791765108580529087615802250458013685625.0_BK,24403480234538299231733883413666768614198435948125.0_BK,-163359140754958502896104062604202934925448173291477.0_BK,730367145705123976114617970888707594104468177381925.0_BK,-2284251621937242886581917667066122422330060024456125.0_BK,5136561256208409671660362298619778869859994724706875.0_BK,-8420533422834140468835467666391400380550043688871875.0_BK,10085018700249896522602267572484630409640764997271875.0_BK,-8735135969643867540297524795790262235822823374296875.0_BK,5329871927856528282113994744458999865006055974609375.0_BK,-2173722139119126857509156976742601742357422740234375.0_BK,532039967451707060045861997017872377315039521484375.0_BK,-59115551939078562227317999668652486368337724609375.0_BK]) / 9820310310243703368343697227776000000.0_BK
        u(14) = evalpoly(15,p2,[5448320367052402487647812713291015625.0_BK,-1338184074771428116079233795614103631250.0_BK,57170953417612444837142230812990944671875.0_BK,-1000503839668383458999731491914516564625300.0_BK,9440449669103391509091075981237243128469201.0_BK,-54857705817658080981995319669299096598482382.0_BK,211477117385619365164298957821904115470535555.0_BK,-564850830044980230366140582063618983657685400.0_BK,1070439683260179398514645952824098811025619475.0_BK,-1451823699927947602004297385351260623500372750.0_BK,1401302601668131482630653233972052729323190625.0_BK,-940627071986145750405920450097257805227812500.0_BK,417630985812040040477569028872405152769921875.0_BK,-110320224449895843354117801955418504167031250.0_BK,13133360053559028970728309756597440972265625.0_BK]) / 45846453362482275295722209280000.0_BK
        u(13) = evalpoly(14,p2,[17438611142828905996129258798828125.0_BK,-3698121486504259988094897605296209375.0_BK,136735019134677724428035696765082813750.0_BK,-2069933923586966756183324291232117362250.0_BK,16843538631795795357786827345307534156063.0_BK,-83924867223075156862785921508524155665245.0_BK,274983827478138958623041508409195988431140.0_BK,-616410216242554698436702353237166008656700.0_BK,962926533925253374359704288384340809260875.0_BK,-1049095945162229046324321461816274931715625.0_BK,782463969315283937856703223178540650343750.0_BK,-381190503845282445953419057314665534156250.0_BK,109361210755577700442544717509565392265625.0_BK,-14020668045586884672121117629431460546875.0_BK]) / 955134445051714068660879360000.0_BK
        u(12) = evalpoly(13,p2,[120907703923613748239829527671875.0_BK,-21882222767154197351962677311437500.0_BK,692277766674325563109617997687563750.0_BK,-8958590476947726766450604043798559500.0_BK,62055079517573388459132793029571876461.0_BK,-261201165596865827608687437905740780920.0_BK,714528665351965363868467348116538170900.0_BK,-1314368459332124683504418467809129387000.0_BK,1642838631056253395899341314188134178125.0_BK,-1378260730939829908037976894025628887500.0_BK,743739612850105971846901081692858843750.0_BK,-233469939346545526651936774615688437500.0_BK,32426380464797989812768996474401171875.0_BK]) / 39797268543821419527536640000.0_BK
        u(11) = evalpoly(12,p2,[15237265774872558064250728125.0_BK,-2321657500166464779660536015625.0_BK,62011003282542082472252466220875.0_BK,-676389476843440422173605288596087.0_BK,3926191452593448964331218647028194.0_BK,-13704902022868787041097596217578170.0_BK,30589806122850866110941936529264950.0_BK,-44801790321820682384740638703320750.0_BK,42936745153513007436411401865860625.0_BK,-25963913760458280822131901737878125.0_BK,8997860461116953237934638500359375.0_BK,-1363312191078326248171914924296875.0_BK]) / 27636992044320430227456000.0_BK
        u(10) = evalpoly(11,p2,[9745329584487361980740625.0_BK,-1230031256571145165088463750.0_BK,27299183373230345667273718125.0_BK,-246750339886026017414509498824.0_BK,1177120360439828012193658602930.0_BK,-3327704366990695147540934069220.0_BK,5876803711285273203043452095250.0_BK,-6564241639632418015173104205000.0_BK,4513386761946134740461797128125.0_BK,-1745632061522350031610173343750.0_BK,290938676920391671935028890625.0_BK]) / 88580102706155225088000.0_BK
        u(9)  = evalpoly(10,p2,[6427469716717690265625.0_BK,-659033454841709672064375.0_BK,11921080954211358275362500.0_BK,-87432034049652400520788332.0_BK,334380732677827878090447630.0_BK,-741743213039573443221773250.0_BK,992115946599792610768672500.0_BK,-790370708270219620781737500.0_BK,345821892003106984030190625.0_BK,-64041091111686478524109375.0_BK]) / 263631258054033408000.0_BK
        u(8)  = evalpoly(9,p2,[134790179652253125.0_BK,-10960565081605263000.0_BK,157768535329832893644.0_BK,-914113758588905038248.0_BK,2711772922412520971550.0_BK,-4513690624987320777000.0_BK,4272845805510421639500.0_BK,-2152114239059719935000.0_BK,448357133137441653125.0_BK]) / 22191183337881600.0_BK
        u(7)  = evalpoly(8,p2,[199689155040375.0_BK,-12493049053044375.0_BK,138799253740521843.0_BK,-613221795981706275.0_BK,1347119637570231525.0_BK,-1570320948552481125.0_BK,931766432052080625.0_BK, -221849150488590625.0_BK]) / 115579079884800.0_BK
        u(6)  = evalpoly(7,p2,[2757049477875.0_BK,-127577298354750.0_BK,1050760774457901.0_BK,-3369032068261860.0_BK,5104696716244125.0_BK,-3685299006138750.0_BK,1023694168371875.0_BK]) / 4815794995200.0_BK
        u(5)  = evalpoly(6,p2,[1519035525.0_BK,-49286948607.0_BK,284499769554.0_BK,-614135872350.0_BK,566098157625.0_BK,-188699385875.0_BK]) / 6688604160.0_BK
        u(4)  = evalpoly(5,p2,[4465125.0_BK,-94121676.0_BK,349922430.0_BK,-446185740.0_BK,185910725.0_BK]) / 39813120.0_BK
        u(3)  = evalpoly(4,p2,[30375.0_BK,-369603.0_BK,765765.0_BK,-4254250.0_BK]) / 414720.0_BK
        u(2)  = evalpoly(3,p2,[81.0_BK,-462.0_BK,385.0_BK]) / 1152.0_BK
        u(1)  = evalpoly(2,p2,[3.0_BK,-5.0_BK]) / 24.0_BK
        u(0)  = ONE
        return
    end subroutine Uk_poly_Jn_generic

    pure function a_ap_poly_10(nu, x) result(aap)
        real(BK), intent(in) :: nu,x
        real(BK) :: xinv,amu,p(11),aap(2)

        xinv = (ONE/x)**2
        amu  = FOUR*nu**2

        p(11) = evalpoly(11, amu, [-7.181611223268327e10_BK, 8.659091218989731e10_BK, -1.576853447634526e10_BK, 1.0243675365394899e9_BK, -3.1127612822052997e7_BK, 499001.19046756154_BK, -4427.281508191307_BK, 21.557856538012857_BK, -0.053067848184582544_BK, 5.209072696743533e-5_BK, -8.843926480039954e-9_BK])
        p(10) = evalpoly(10, amu, [8.369564497799761e8_BK, -1.0061560971482614e9_BK, 1.80175839935865e8_BK, -1.1293844119552301e7_BK, 322272.3393258663_BK, -4655.44006793818_BK, 34.77845393284224_BK, -0.12591543863527477_BK, 0.0001761710154823959_BK, -4.1618477553129196e-8_BK])
        p(9)  = evalpoly(9, amu, [-1.225106763286615e7_BK, 1.4670878180751745e7_BK, -2.5692206274838205e6_BK, 153362.43350451812_BK, -4001.4928083932027_BK, 49.41718461737037_BK, -0.2788656409829855_BK, 0.0005833245813846588_BK, -1.9976869225502014e-7_BK])
        p(8)  = evalpoly(8, amu, [231884.6359563172_BK, -276225.9131319225_BK, 46889.68168082833_BK, -2607.1347218453884_BK, 59.29277476668358_BK, -0.5644365847110748_BK, 0.0018794238567352295_BK, -9.834766387939453e-7_BK])
        p(7)  = evalpoly(7, amu, [-5892.0457146167755_BK, 6965.548173427582_BK, -1128.6143367290497_BK, 56.11658954620361_BK, -1.0105445384979248_BK, 0.005837917327880859_BK, -5.0067901611328125e-6_BK])
        p(6)  = evalpoly(6, amu, [211.27614974975586_BK, -246.8455924987793_BK, 37.067405700683594_BK, -1.5151596069335938_BK, 0.017223358154296875_BK, -2.6702880859375e-5_BK])
        p(5)  = evalpoly(5, amu, [-11.466461181640625_BK, 13.1358642578125_BK, -1.71624755859375_BK, 0.0469970703125_BK, -0.000152587890625_BK])
        p(4)  = evalpoly(4, amu, [1.0478515625_BK, -1.1591796875_BK, 0.1123046875_BK, -0.0009765625_BK])
        p(3)  = evalpoly(3, amu, [-0.1953125_BK, 0.203125_BK, -0.0078125_BK])
        p(2)  = evalpoly(2, amu, [0.125_BK, -0.125_BK])
        p(1)  = ONE

        aap = split_phase_evalpoly(size(P),xinv,P)
        aap = aap*[x,ONE]

    end function a_ap_poly_10


    pure function a_ap_poly_20(nu, x) result(aap)
        real(BK), intent(in) :: nu,x
        real(BK) :: xinv,amu,p(21),aap(2)

        xinv = (ONE/x)**2
        amu  = FOUR*nu**2

        p(21) = evalpoly(21, amu, [-1.1655823449858069e34_BK, 1.4226232333293694e34_BK, -2.7683048917097874e33_BK, 2.0549175959945544e32_BK, -7.766193794571668e30_BK, 1.7289192571208397e29_BK, -2.473355129610242e27_BK, 2.406335820680262e25_BK, -1.6548511836241395e23_BK, 8.261988206301513e20_BK, -3.048956971903377e18_BK, 8.409146358453666e15_BK, -1.7416884938569994e13_BK, 2.7048317602344254e10_BK, -3.1216507081066556e7_BK, 26272.21159305084_BK, -15.578788452840763_BK, 0.0061163849392160095_BK, -1.4107081622121022e-6_BK, 1.4671084930995856e-10_BK, -2.9236916960932355e-15_BK])
        p(20) = evalpoly(20, amu, [3.1436617397720927e31_BK, -3.8346121964186915e31_BK, 7.438172213027661e30_BK, -5.487658176284203e29_BK, 2.0543110479331377e28_BK, -4.512190593153004e26_BK, 6.33949148154985e24_BK, -6.024489803885022e22_BK, 4.020727203383251e20_BK, -1.9328978639294188e18_BK, 6.802550072768408e15_BK, -1.767751414955178e13_BK, 3.3964900375451138e10_BK, -4.792703592867111e7_BK, 48822.71795456563_BK, -34.73905348751307_BK, 0.01624286720956346_BK, -4.43222001918643e-6_BK, 5.421693881235296e-10_BK, -1.2642991118241018e-14_BK])
        p(19) = evalpoly(19, amu, [-9.432675683095812e28_BK, 1.1498154949132059e29_BK, -2.2224123014148547e28_BK, 1.6283472309548362e27_BK, -6.03034763221407e25_BK, 1.3043849059659297e24_BK, -1.7950710383376238e22_BK, 1.6602291470434327e20_BK, -1.0700309670904285e18_BK, 4.92026735148727e15_BK, -1.6365119263912514e13_BK, 3.957355516860315e10_BK, -6.930551343828379e7_BK, 86599.59532013819_BK, -74.82883257079231_BK, 0.042123857348712865_BK, -1.3735762526818516e-5_BK, 1.994760566671595e-9_BK, -5.490670428493242e-14_BK])
        p(18) = evalpoly(18, amu, [3.167717078292175e26_BK, -3.8584266638650446e26_BK, 7.4277307068246446e25_BK, -5.399729057323595e24_BK, 1.9752248974202056e23_BK, -4.197842582814349e21_BK, 5.640147455618286e19_BK, -5.0538188484912346e17_BK, 3.1258357574848365e15_BK, -1.3629748027461303e13_BK, 4.233000035928751e10_BK, -9.36296364559977e7_BK, 145724.23973885347_BK, -155.01792293897955_BK, 0.10637041031529318_BK, -4.191933776256961e-5_BK, 7.303030923530292e-9_BK, -2.3959289142515966e-13_BK])
        p(17) = evalpoly(17, amu, [-1.1986350446061028e24_BK, 1.458736721654471e24_BK, -2.795293505867967e23_BK, 2.0139038975089457e22_BK, -7.262922096794037e20_BK, 1.5122633519520676e19_BK, -1.975555191650512e17_BK, 1.7050149800082885e15_BK, -1.0037673890747877e13_BK, 4.1025284625807785e10_BK, -1.1700278886842367e8_BK, 230919.39384718135_BK, -307.22947128726474_BK, 0.260626935759175_BK, -0.0001257334987819726_BK, 2.658906071879852e-8_BK, -1.051117201091023e-12_BK])
        p(16) = evalpoly(16, amu, [5.149237018485509e21_BK, -6.260437088008504e21_BK, 1.1933270317945127e21_BK, -8.508441473311652e19_BK, 3.0180281284560543e18_BK, -6.1344355915029736e16_BK, 7.750474619361342e14_BK, -6.393706192980096e12_BK, 3.543452904857713e10_BK, -1.3358182185805681e8_BK, 341472.1144099866_BK, -578.7806110577233_BK, 0.6169921485050097_BK, -0.00036976968916281605_BK, 9.619824624385043e-8_BK, -4.639413853091412e-12_BK])
        p(15) = evalpoly(15, amu, [-2.5330554576498356e19_BK, 3.0761765051109855e19_BK, -5.827690025164462e18_BK, 4.1047854971841363e17_BK, -1.4277576770556304e16_BK, 2.819724813029272e14_BK, -3.4214400566025547e12_BK, 2.670056925037507e10_BK, -1.3717353508462998e8_BK, 465890.6725849346_BK, -1028.1881576107903_BK, 1.4039031226739573_BK, -0.0010631539871280848_BK, 3.4554354377824836e-7_BK, -2.061961712485072e-11_BK])
        p(14) = evalpoly(14, amu, [1.4409993748135704e17_BK, -1.747635582560889e17_BK, 3.286944341694018e16_BK, -2.2818860422499875e15_BK, 7.75248528894739e13_BK, -1.4783938404512664e12_BK, 1.7064572063331423e10_BK, -1.2415577730993801e8_BK, 578046.6774168271_BK, -1705.2186748496474_BK, 3.0504712266430722_BK, -0.0029777336087200013_BK, 1.2309086638850886e-6_BK, -9.237588471933122e-11_BK])
        p(13) = evalpoly(13, amu, [-9.588236853265692e14_BK, 1.161016591203577e15_BK, -2.164822377227822e14_BK, 1.4768015151140877e13_BK, -4.8748767898914606e11_BK, 8.900147704533855e9_BK, -9.641151011038888e7_BK, 640028.5410983711_BK, -2606.385824929625_BK, 6.277422845836725_BK, -0.008087900592073538_BK, 4.342405588886322e-6_BK, -4.176996526439325e-10_BK])
        p(12) = evalpoly(12, amu, [7.562132599676877e12_BK, -9.139342212003133e12_BK, 1.686263984004851e12_BK, -1.1257747938365613e11_BK, 3.584384568770644e9_BK, -6.188986771037158e7_BK, 616601.7257690447_BK, -3609.808395761912_BK, 12.103919447801218_BK, -0.021179858537379914_BK, 1.5144118606258417e-5_BK, -1.909484126372263e-9_BK])
        p(11) = evalpoly(11, amu, [-7.181611223268327e10_BK, 8.659091218989731e10_BK, -1.576853447634526e10_BK, 1.0243675365394899e9_BK, -3.1127612822052997e7_BK, 499001.19046756154_BK, -4427.281508191307_BK, 21.557856538012857_BK, -0.053067848184582544_BK, 5.209072696743533e-5_BK, -8.843926480039954e-9_BK])
        p(10) = evalpoly(10, amu, [8.369564497799761e8_BK, -1.0061560971482614e9_BK, 1.80175839935865e8_BK, -1.1293844119552301e7_BK, 322272.3393258663_BK, -4655.44006793818_BK, 34.77845393284224_BK, -0.12591543863527477_BK, 0.0001761710154823959_BK, -4.1618477553129196e-8_BK])
        p(9)  = evalpoly( 9, amu, [-1.225106763286615e7_BK, 1.4670878180751745e7_BK, -2.5692206274838205e6_BK, 153362.43350451812_BK, -4001.4928083932027_BK, 49.41718461737037_BK, -0.2788656409829855_BK, 0.0005833245813846588_BK, -1.9976869225502014e-7_BK])
        p(8)  = evalpoly( 8, amu, [231884.6359563172_BK, -276225.9131319225_BK, 46889.68168082833_BK, -2607.1347218453884_BK, 59.29277476668358_BK, -0.5644365847110748_BK, 0.0018794238567352295_BK, -9.834766387939453e-7_BK])
        p(7)  = evalpoly( 7, amu, [-5892.0457146167755_BK, 6965.548173427582_BK, -1128.6143367290497_BK, 56.11658954620361_BK, -1.0105445384979248_BK, 0.005837917327880859_BK, -5.0067901611328125e-6_BK])
        p(6)  = evalpoly( 6, amu, [211.27614974975586_BK, -246.8455924987793_BK, 37.067405700683594_BK, -1.5151596069335938_BK, 0.017223358154296875_BK, -2.6702880859375e-5_BK])
        p(5)  = evalpoly( 5, amu, [-11.466461181640625_BK, 13.1358642578125_BK, -1.71624755859375_BK, 0.0469970703125_BK, -0.000152587890625_BK])
        p(4)  = evalpoly( 4, amu, [1.0478515625_BK, -1.1591796875_BK, 0.1123046875_BK, -0.0009765625_BK])
        p(3)  = evalpoly( 3, amu, [-0.1953125_BK, 0.203125_BK, -0.0078125_BK])
        p(2)  = evalpoly( 2, amu, [0.125_BK, -0.125_BK])
        p(1)  = ONE

        aap = split_phase_evalpoly(size(P),xinv,P)
        aap = aap*[x,ONE]

    end function a_ap_poly_20

    pure function a_ap_poly_30(nu, x) result(aap)
        real(BK), intent(in) :: nu,x
        real(BK) :: xinv,amu,p(31),aap(2)

        xinv = (ONE/x)**2
        amu  = FOUR*nu**2

        p(31) = evalpoly_xl(31, amu, [-7.592029625744128e61_BK, 9.300807898884993e61_BK, -1.8453653700408117e61_BK, 1.4213662513968141e60_BK, -5.684267643368571e58_BK, 1.3688721521734006e57_BK, -2.1717210753568686e55_BK, 2.410362055956752e53_BK, -1.953160895382593e51_BK, 1.1926329508677187e49_BK, -5.621526725185766e46_BK, 2.084010993835956e44_BK, -6.16598654084696e41_BK, 1.472798231204338e39_BK, -2.8653790379578294e36_BK, 4.5711759648399396e33_BK, -6.008229949414824e30_BK, 6.525582948238488e27_BK, -5.863525845645105e24_BK, 4.3559252317865593e21_BK, -2.6682229171870643e18_BK, 1.3409000748848645e15_BK, -5.4845348768282446e11_BK, 1.8042426705573353e8_BK, -46913.0207873715_BK, 9.39407807634952_BK, -0.0013913710768178739_BK, 1.4251320396079487e-7_BK, -8.917800204478063e-12_BK, 2.6068908049173686e-16_BK, -1.5080064817014915e-21_BK])
        p(30) = evalpoly_xl(30, amu, [8.871640240590993e58_BK, -1.0865691207568645e59_BK, 2.153044379065757e58_BK, -1.654292598675498e57_BK, 6.591312178536168e55_BK, -1.5792626981209235e54_BK, 2.4890507915218916e52_BK, -2.7398535977577976e50_BK, 2.1978557435213864e48_BK, -1.3258581553903244e46_BK, 6.160064953128667e43_BK, -2.24525395106052e41_BK, 6.512651083776791e38_BK, -1.520126754804397e36_BK, 2.879357904563898e33_BK, -4.453253892004961e30_BK, 5.646779978807957e27_BK, -5.882834513685185e24_BK, 5.036061410449725e21_BK, -3.535410901341911e18_BK, 2.0262400502486065e15_BK, -9.410029770358712e11_BK, 3.500781492364049e8_BK, -102565.9203518178_BK, 23.065519747567176_BK, -0.003825019881917803_BK, 4.374396753566091e-7_BK, -3.048458029283708e-11_BK, 9.900967356259312e-16_BK, -6.3495009755852275e-21_BK])
        p(29) = evalpoly_xl(29, amu, [-1.1113660587118494e56_BK, 1.360796163396552e56_BK, -2.692648562464633e55_BK, 2.0634410442908336e54_BK, -8.188692555802185e52_BK, 1.9512412867297912e51_BK, -3.0534326199740573e49_BK, 3.3310997303957132e47_BK, -2.6429272553053182e45_BK, 1.573358131379098e43_BK, -7.195503085038196e40_BK, 2.5742410447166102e38_BK, -7.305470671594484e35_BK, 1.6621868613473995e33_BK, -3.056128428896728e30_BK, 4.5656808004766417e27_BK, -5.560280477035352e24_BK, 5.525982611412455e21_BK, -4.4762143769251487e18_BK, 2.944057191090032e15_BK, -1.561376913130651e12_BK, 6.60436019199837e8_BK, -219122.78889988337_BK, 55.602561558610454_BK, -0.010370022987617815_BK, 1.3297453832052619e-6_BK, -1.0361746982713131e-10_BK, 3.753418608703549e-15_BK, -2.6783349569741323e-20_BK])
        p(28) = evalpoly_xl(28, amu, [1.4962552090981924e53_BK, -1.8315342344152888e53_BK, 3.6186332587139524e52_BK, -2.7651411770117913e51_BK, 1.092593756883467e50_BK, -2.5880088398643682e48_BK, 4.0185482602383215e46_BK, -4.341325948517365e44_BK, 3.40330197791503e42_BK, -1.996788871925338e40_BK, 8.974814912978575e37_BK, -3.1454308144632116e35_BK, 8.712781142577153e32_BK, -1.926817207371682e30_BK, 3.4266421642703216e27_BK, -4.923376108039163e24_BK, 5.727723667496557e21_BK, -5.393876507549732e18_BK, 4.099268265682976e15_BK, -2.498492707776039e12_BK, 1.2086394541382809e9_BK, -456609.83322422515_BK, 131.40817769348385_BK, -0.027695807224792045_BK, 4.000233368100494e-6_BK, -3.500503095889607e-10_BK, 1.4200746208673407e-14_BK, -1.1319755289852937e-19_BK])
        p(27) = evalpoly_xl(27, amu, [-2.170796074547977e50_BK, 2.6563886780963143e50_BK, -5.239744551853566e49_BK, 3.9915243203539826e48_BK, -1.5697710844957169e47_BK, 3.694226454576932e45_BK, -5.687790414754595e43_BK, 6.07923257088654e41_BK, -4.703231744077508e39_BK, 2.715669597352839e37_BK, -1.1973880447446774e35_BK, 4.101798034247621e32_BK, -1.1059082744278117e30_BK, 2.3689970250205793e27_BK, -4.057770223206878e24_BK, 5.577674944614657e21_BK, -6.157880219725851e18_BK, 5.448993990587677e15_BK, -3.8435237604702446e12_BK, 2.1401262084993436e9_BK, -926134.0995426074_BK, 303.9782133922326_BK, -0.07278018905169194_BK, 1.1898982367956518e-5_BK, -1.1748038677566303e-9_BK, 5.361217221358988e-14_BK, -4.794249299231832e-19_BK])
        p(26) = evalpoly_xl(26, amu, [3.4037481878842518e47_BK, -4.163722422572948e47_BK, 8.198385202264364e46_BK, -6.22435990386475e45_BK, 2.4353618503436353e44_BK, -5.690731110001809e42_BK, 8.680616408346572e40_BK, -9.169497515863974e38_BK, 6.991529767882026e36_BK, -3.9660440566717967e34_BK, 1.7117897755074633e32_BK, -5.716342746132164e29_BK, 1.495186253411991e27_BK, -3.089698915505606e24_BK, 5.071094031947313e21_BK, -6.62564031827467e18_BK, 6.884682491993269e15_BK, -5.663687113496129e12_BK, 3.6558083666029415e9_BK, -1.8241160174217927e6_BK, 687.0067933018984_BK, -0.1879264018835715_BK, 3.496541491784091e-5_BK, -3.914759734732158e-9_BK, 2.0193378048364477e-13_BK, -2.035109906612696e-18_BK])
        p(25) = evalpoly_xl(25, amu, [-5.786059033524315e44_BK, 7.075318200534661e44_BK, -1.3904375539321083e44_BK, 1.051770598467428e43_BK, -4.0921342782576984e41_BK, 9.487906954286141e39_BK, -1.4325415965940442e38_BK, 1.493677625028016e36_BK, -1.1206631946323043e34_BK, 6.2329465039514265e31_BK, -2.626782977025989e29_BK, 8.52403241555426e26_BK, -2.1544180262833415e24_BK, 4.273241060880315e21_BK, -6.678193343397941e18_BK, 8.226793217207085e15_BK, -7.9615210223039795e12_BK, 6.004451011853662e9_BK, -3.4795218728555855e6_BK, 1513.831326319914_BK, -0.4760701870709445_BK, 0.00010139500470517733_BK, -1.2944568154864108e-8_BK, 7.586889731852131e-13_BK, -8.660042155798706e-18_BK])
        p(24) = evalpoly_xl(24, amu, [1.0699708275991454e42_BK, -1.3078533633276038e42_BK, 2.5647480608865752e41_BK, -1.9322501955238208e40_BK, 7.471528599453178e38_BK, -1.7175047656287374e37_BK, 2.56398527252613e35_BK, -2.6350896428114214e33_BK, 1.9417708082703794e31_BK, -1.0563755426904998e29_BK, 4.333903992576568e26_BK, -1.3614388053852227e24_BK, 3.3089693719445074e21_BK, -6.261128573879847e18_BK, 9.243346554045246e15_BK, -1.0625592945166727e13_BK, 9.4457596395905e9_BK, -6.4083469576330995e6_BK, 3244.624388704194_BK, -1.1811472686414501_BK, 0.0002898188382446864_BK, -4.2443950630387665e-8_BK, 2.84271079789386e-12_BK, -3.694951319807448e-17_BK])
        p(23) = evalpoly_xl(23, amu, [-2.1603839510459968e39_BK, 2.639521237493071e39_BK, -5.164169654060501e38_BK, 3.873385769490781e37_BK, -1.4875551809791352e36_BK, 3.3870740530372218e34_BK, -4.993086633044377e32_BK, 5.049452384590897e30_BK, -3.646484825050138e28_BK, 1.934929035289944e26_BK, -7.699788293506606e23_BK, 2.3306500988206443e21_BK, -5.414879939834449e18_BK, 9.69892178268169e15_BK, -1.3389590376401615e13_BK, 1.4169012254830626e10_BK, -1.1355350548005087e7_BK, 6745.941285011119_BK, -2.8643019266046954_BK, 0.0008154154591207295_BK, -1.3789599324701242e-7_BK, 1.061958568923219e-11_BK, -1.5810954484757452e-16_BK])
        p(22) = evalpoly_xl(22, amu, [4.7820456670665866e36_BK, -5.839767806978455e36_BK, 1.139609569657776e36_BK, -8.505736729879162e34_BK, 3.241923388548771e33_BK, -7.303696541971675e31_BK, 1.061598557628623e30_BK, -1.0542835823932327e28_BK, 7.4416439961740466e25_BK, -3.8383112218012e23_BK, 1.4749530840065974e21_BK, -4.277160387520148e18_BK, 9.428034079487212e15_BK, -1.582775791680076e13_BK, 2.0161618573658318e10_BK, -1.9279964972155876e7_BK, 13562.78784549061_BK, -6.773533616718505_BK, 0.0022547380647248_BK, -4.4351435924730097e-7_BK, 3.9542564728199e-11_BK, -6.787141437359297e-16_BK])
        p(21) = evalpoly(21, amu, [-1.1655823449858069e34_BK, 1.4226232333293694e34_BK, -2.7683048917097874e33_BK, 2.0549175959945544e32_BK, -7.766193794571668e30_BK, 1.7289192571208397e29_BK, -2.473355129610242e27_BK, 2.406335820680262e25_BK, -1.6548511836241395e23_BK, 8.261988206301513e20_BK, -3.048956971903377e18_BK, 8.409146358453666e15_BK, -1.7416884938569994e13_BK, 2.7048317602344254e10_BK, -3.1216507081066556e7_BK, 26272.21159305084_BK, -15.578788452840763_BK, 0.0061163849392160095_BK, -1.4107081622121022e-6_BK, 1.4671084930995856e-10_BK, -2.9236916960932355e-15_BK])
        p(20) = evalpoly(20, amu, [3.1436617397720927e31_BK, -3.8346121964186915e31_BK, 7.438172213027661e30_BK, -5.487658176284203e29_BK, 2.0543110479331377e28_BK, -4.512190593153004e26_BK, 6.33949148154985e24_BK, -6.024489803885022e22_BK, 4.020727203383251e20_BK, -1.9328978639294188e18_BK, 6.802550072768408e15_BK, -1.767751414955178e13_BK, 3.3964900375451138e10_BK, -4.792703592867111e7_BK, 48822.71795456563_BK, -34.73905348751307_BK, 0.01624286720956346_BK, -4.43222001918643e-6_BK, 5.421693881235296e-10_BK, -1.2642991118241018e-14_BK])
        p(19) = evalpoly(19, amu, [-9.432675683095812e28_BK, 1.1498154949132059e29_BK, -2.2224123014148547e28_BK, 1.6283472309548362e27_BK, -6.03034763221407e25_BK, 1.3043849059659297e24_BK, -1.7950710383376238e22_BK, 1.6602291470434327e20_BK, -1.0700309670904285e18_BK, 4.92026735148727e15_BK, -1.6365119263912514e13_BK, 3.957355516860315e10_BK, -6.930551343828379e7_BK, 86599.59532013819_BK, -74.82883257079231_BK, 0.042123857348712865_BK, -1.3735762526818516e-5_BK, 1.994760566671595e-9_BK, -5.490670428493242e-14_BK])
        p(18) = evalpoly(18, amu, [3.167717078292175e26_BK, -3.8584266638650446e26_BK, 7.4277307068246446e25_BK, -5.399729057323595e24_BK, 1.9752248974202056e23_BK, -4.197842582814349e21_BK, 5.640147455618286e19_BK, -5.0538188484912346e17_BK, 3.1258357574848365e15_BK, -1.3629748027461303e13_BK, 4.233000035928751e10_BK, -9.36296364559977e7_BK, 145724.23973885347_BK, -155.01792293897955_BK, 0.10637041031529318_BK, -4.191933776256961e-5_BK, 7.303030923530292e-9_BK, -2.3959289142515966e-13_BK])
        p(17) = evalpoly(17, amu, [-1.1986350446061028e24_BK, 1.458736721654471e24_BK, -2.795293505867967e23_BK, 2.0139038975089457e22_BK, -7.262922096794037e20_BK, 1.5122633519520676e19_BK, -1.975555191650512e17_BK, 1.7050149800082885e15_BK, -1.0037673890747877e13_BK, 4.1025284625807785e10_BK, -1.1700278886842367e8_BK, 230919.39384718135_BK, -307.22947128726474_BK, 0.260626935759175_BK, -0.0001257334987819726_BK, 2.658906071879852e-8_BK, -1.051117201091023e-12_BK])
        p(16) = evalpoly(16, amu, [5.149237018485509e21_BK, -6.260437088008504e21_BK, 1.1933270317945127e21_BK, -8.508441473311652e19_BK, 3.0180281284560543e18_BK, -6.1344355915029736e16_BK, 7.750474619361342e14_BK, -6.393706192980096e12_BK, 3.543452904857713e10_BK, -1.3358182185805681e8_BK, 341472.1144099866_BK, -578.7806110577233_BK, 0.6169921485050097_BK, -0.00036976968916281605_BK, 9.619824624385043e-8_BK, -4.639413853091412e-12_BK])
        p(15) = evalpoly(15, amu, [-2.5330554576498356e19_BK, 3.0761765051109855e19_BK, -5.827690025164462e18_BK, 4.1047854971841363e17_BK, -1.4277576770556304e16_BK, 2.819724813029272e14_BK, -3.4214400566025547e12_BK, 2.670056925037507e10_BK, -1.3717353508462998e8_BK, 465890.6725849346_BK, -1028.1881576107903_BK, 1.4039031226739573_BK, -0.0010631539871280848_BK, 3.4554354377824836e-7_BK, -2.061961712485072e-11_BK])
        p(14) = evalpoly(14, amu, [1.4409993748135704e17_BK, -1.747635582560889e17_BK, 3.286944341694018e16_BK, -2.2818860422499875e15_BK, 7.75248528894739e13_BK, -1.4783938404512664e12_BK, 1.7064572063331423e10_BK, -1.2415577730993801e8_BK, 578046.6774168271_BK, -1705.2186748496474_BK, 3.0504712266430722_BK, -0.0029777336087200013_BK, 1.2309086638850886e-6_BK, -9.237588471933122e-11_BK])
        p(13) = evalpoly(13, amu, [-9.588236853265692e14_BK, 1.161016591203577e15_BK, -2.164822377227822e14_BK, 1.4768015151140877e13_BK, -4.8748767898914606e11_BK, 8.900147704533855e9_BK, -9.641151011038888e7_BK, 640028.5410983711_BK, -2606.385824929625_BK, 6.277422845836725_BK, -0.008087900592073538_BK, 4.342405588886322e-6_BK, -4.176996526439325e-10_BK])
        p(12) = evalpoly(12, amu, [7.562132599676877e12_BK, -9.139342212003133e12_BK, 1.686263984004851e12_BK, -1.1257747938365613e11_BK, 3.584384568770644e9_BK, -6.188986771037158e7_BK, 616601.7257690447_BK, -3609.808395761912_BK, 12.103919447801218_BK, -0.021179858537379914_BK, 1.5144118606258417e-5_BK, -1.909484126372263e-9_BK])
        p(11) = evalpoly(11, amu, [-7.181611223268327e10_BK, 8.659091218989731e10_BK, -1.576853447634526e10_BK, 1.0243675365394899e9_BK, -3.1127612822052997e7_BK, 499001.19046756154_BK, -4427.281508191307_BK, 21.557856538012857_BK, -0.053067848184582544_BK, 5.209072696743533e-5_BK, -8.843926480039954e-9_BK])
        p(10) = evalpoly(10, amu, [8.369564497799761e8_BK, -1.0061560971482614e9_BK, 1.80175839935865e8_BK, -1.1293844119552301e7_BK, 322272.3393258663_BK, -4655.44006793818_BK, 34.77845393284224_BK, -0.12591543863527477_BK, 0.0001761710154823959_BK, -4.1618477553129196e-8_BK])
        p(9)  = evalpoly( 9, amu, [-1.225106763286615e7_BK, 1.4670878180751745e7_BK, -2.5692206274838205e6_BK, 153362.43350451812_BK, -4001.4928083932027_BK, 49.41718461737037_BK, -0.2788656409829855_BK, 0.0005833245813846588_BK, -1.9976869225502014e-7_BK])
        p(8)  = evalpoly( 8, amu, [231884.6359563172_BK, -276225.9131319225_BK, 46889.68168082833_BK, -2607.1347218453884_BK, 59.29277476668358_BK, -0.5644365847110748_BK, 0.0018794238567352295_BK, -9.834766387939453e-7_BK])
        p(7)  = evalpoly( 7, amu, [-5892.0457146167755_BK, 6965.548173427582_BK, -1128.6143367290497_BK, 56.11658954620361_BK, -1.0105445384979248_BK, 0.005837917327880859_BK, -5.0067901611328125e-6_BK])
        p(6)  = evalpoly( 6, amu, [211.27614974975586_BK, -246.8455924987793_BK, 37.067405700683594_BK, -1.5151596069335938_BK, 0.017223358154296875_BK, -2.6702880859375e-5_BK])
        p(5)  = evalpoly( 5, amu, [-11.466461181640625_BK, 13.1358642578125_BK, -1.71624755859375_BK, 0.0469970703125_BK, -0.000152587890625_BK])
        p(4)  = evalpoly( 4, amu, [1.0478515625_BK, -1.1591796875_BK, 0.1123046875_BK, -0.0009765625_BK])
        p(3)  = evalpoly( 3, amu, [-0.1953125_BK, 0.203125_BK, -0.0078125_BK])
        p(2)  = evalpoly( 2, amu, [0.125_BK, -0.125_BK])
        p(1)  = ONE

        aap = split_phase_evalpoly(size(P),xinv,P)
        aap = aap*[x,ONE]

    end function a_ap_poly_30

    ! besseljy_large_argument(nu, x::T)
    ! Asymptotic expansions for large arguments valid when x > 1.6*nu and x > 20.0.
    ! Returns both (besselj(nu, x), bessely(nu, x_BK]).
    elemental subroutine besseljy_large_argument(nu, x, besselj, bessely)
       real(BK), intent(in) :: nu, x
       real(BK), intent(out) :: besselj, bessely

       real(BK) :: aap(2),b,s,c,sa,ca,CMS,CPS,s1,s2,s3,s4

       ! [a, ap]
       aap = a_ap_asymptotic(nu, x)

       b = SQ2OPI / sqrt(aap(2)*x)

       ! we need to calculate sin(x - v*pi/2 - pi/4) and cos(x - v*pi/2 - pi/4)
       ! For improved accuracy this is expanded using the formula for sin(x+y+z)
       s = sin(PIO2*nu)
       c = cos(PIO2*nu)
       sa = sin(aap(1))
       ca = cos(aap(1))

       CMS = c - s
       CPS = c + s

       s1 = CMS * ca
       s2 = CPS * sa

       s3 = CMS * sa
       s4 = CPS * ca

       besselj = SQ2O2 * (s1 + s2) * b
       bessely = SQ2O2 * (s3 - s4) * b
    end subroutine besseljy_large_argument

    ! Float64
    ! can only use for x > 20.0
    ! 30 terms gives ~5e-16 relative error when x > 1.6*nu
    ! 20 terms gives ~2e-16 relative error when x > 2*nu
    ! 15 terms gives ~5e-18 relative error when x > 3*nu
    ! 10 terms gives ~3e-18 relative error when x > 5*nu
    ! 5 terms give  ~5e-15 relative erros when x > 20*nu
    ! 3 terms give  ~5e-15 relative erros when x > 50*nu
    ! 2 terms give  ~5e-15 relative erros when x > 500*nu

    ! Float32
    ! can only use for x > 15.0
    ! 30 terms gives ~2e-8 relative error when x > 1.2*nu
    ! 20 terms gives ~8e-8 relative error when x > 1.3*nu
    ! 15 terms gives ~8e-8 relative error when x > 1.4*nu
    ! 10 terms gives ~3e-8 relative error when x > 1.8*nu
    ! 5 terms give  ~8e-8 relative erros when x > 4*nu
    ! 3 terms give  ~2e-8 relative erros when x > 8*nu

    ! Float128
    ! can only use for x > 40.0
    ! 30 terms gives ~5e-34 relative error when x > 4*nu
    ! 20 terms gives ~6e-34 relative error when x > 5.5*nu
    ! 15 terms gives ~6e-34 relative error when x > 8.5*nu
    ! 10 terms gives ~3e-34 relative error when x > 30*nu

    ! can fit a rational function to trend (numer of terms on y axis; x/nu on x axis)
    ! to get the number of terms needed for desired precision as function of x/nu
    ! terms = a / (x/nu) + b / (x/nu)^2 + c
    !
    ! to get number of terms required for Float64 precision
    ! a = 27.7479; b = 22.3588; c = 3.74567
    ! this method requires significantly more terms when x gets closer to nu
    ! so it becomes more efficient to use recurrence (or another algorithm) in this region

    pure function a_ap_asymptotic(nu, x) result(aap)
       real(BK), intent(in) :: nu, x
       real(BK) :: aap(2)
        if (x > 5*nu) then
            aap = a_ap_poly_10(nu, x)
        elseif (x > 2*nu) then
            aap = a_ap_poly_20(nu, x)
        else
            aap = a_ap_poly_30(nu, x)
        endif
    end function a_ap_asymptotic

    ! this function evaluates the phase and integral at the same time (more efficiently) for example given
    ! some polynomial P with coeffficients s0, s1, ...
    ! we use this function when the size of P is large (size(P) > 20) as it is more efficient
    ! this functions returns [a, ap]:
    ! alphap = evalpoly(xinv, (s(0:29))
    ! Î±  = x * evalpoly(xinv, [s(0), -s(1), -s(2)/3, -s(3)/5, -s(4)/7, ..., -s(29)/57])
    pure function split_phase_evalpoly(N, x, P) result(aap)
        integer, intent(in) :: N
        real(BK), intent(in) :: x, P(N)
        real(BK) :: aap(2)

        ! ap*(2) is [a*,ap*] in Bessels.jl
        real(BK) :: xx,ap1(2),ap2(2),d
        integer :: i

        xx = x**2

        ap1(2) = P(N)
        ap2(2) = P(N-1)

        d      = -(TWO*N-THREE)
        ap1(1) = ap1(2)/d
        ap2(1) = -ap2(2)/(d+TWO)
        d      = d+FOUR

        do i = N-2,2,-2
            ap1 = xx*ap1 + P(i)  *[ONE/d,ONE]
            ap2 = xx*ap2 + P(i-1)*[ONE/(d+TWO),ONE]
            d  = d+FOUR
        end do

        if (mod(N,2)==0) then
            aap = x*ap1+ap2
        else
            ap1 = xx*ap1+P(1)
            aap = x*ap2+ap1
        endif
    end function split_phase_evalpoly

    ! performs a second order horner scheme for polynomial evaluation
    ! computes the even and odd coefficients of the polynomial independently within a loop to reduce latency
    ! works for both even and odd degree polynomials
    pure real(BK) function evalpoly_xl(N, x, P) result(a)
        integer, intent(in) :: N
        real(BK), intent(in) :: x, P(N)

        real(BK) :: xx,out,out2
        integer :: i
        xx = x*x

        out  = P(N)
        out2 = P(N-1)

        do i = N-2,2,-2
            out  = xx*out +P(i)
            out2 = xx*out2+P(i-1)
        end do

        if (mod(N,2)==0) then
            a = out*x+out2
        else
            out = xx*out+P(1)
            a   = x*out2+out
        endif
    end function evalpoly_xl

end module bessels_debye
